# Windows Defender - Demystifying and Bypassing ASR by Understanding the AV's Signatures[^1]

## ASR[^2]是什么

ASR全称为Attack Surface Reduction，意思是缩小供给面。

ASR 最初是作为 Windows 10 版本 1709 中 Microsoft Defender Antivirus 的主要更新而引入的漏洞利用防护功能套件的一项功能。Microsoft Defender Antivirus 是 Windows 的本机反恶意软件组件。但是，完整的 ASR 功能集仅适用于 Windows 企业许可证。另请注意，ASR 规则排除项与 Microsoft Defender 防病毒排除项是分开管理的。[^4]

### 如何使用ASR[^5]

以禁止Adobe Reader创建子进程为例，配置如下信息即可。

![image-20211206103904492](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206103904492.png)

## 1. Windows Defender: Tooling

Alexei在2018年Balck Hat上介绍了`Windows Offender: Reverse Engineering Windows Defender's Antivirus Emulator`。

### 组件

- Components

* WdFilter: filter driver
* WdBoot: ELAM
* MpSvc.dll, MpClient.dll, MpCmdRun.exe: interfaces
* mpengine.dll: engine implementation[^6]
* mpasbase.vdm , mpavbase.vdm: engine ressources (signatures, emulation ressources, etc.)

- PDB for mpengine.dll availables until ~2020

### 插桩调试

![image-20211206105504074](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206105504074.png)

### 一道CTF题目：FCSC 2021 CTF: “The Offenders”

> Writeup: https://xarkes.com/b/fcsc-2021-the-offenders.html



## 2. ASR rules implementation

### 如何分析

在代码中寻找”ASR“。

![image-20211206111029777](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206111029777.png)

在LUA engine里

![image-20211206111104655](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206111104655.png)

![image-20211206111113132](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206111113132.png)

在HipsManager::LoadRulesFromDatabase，

规则数据的一部分必须在签名里，以LUA的形式。

![image-20211206111219435](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206111219435.png)

## 3. Windows Defender's signatures

WDExtract[^7]工具描述VDM是压缩过的文件。

> A **vdm file extension** is related to the **Microsoft Windows** operating system. A **vdm file** contains malware definition.

下图是解压缩的VDM。

![image-20211206111432306](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206111432306.png)

是lua文件，于是尝试[luadec](https://github.com/viruscamp/luadec)，报错。

![image-20211206112020154](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206112020154.png)

After some reverse & digging ([A No-Frills Introduction to Lua 5.1 VM Instructions](http://luaforge.net/docman/83/98/ANoFrillsIntroToLua51VMInstructions.pdf)is a good ref):

* headers are not the ones expected by luadec

* data structures sizes neither

- [naive conversion script](https://github.com/commial/experiments/tree/master/windows-defender/lua)



## 参考资料

[^1]:[Windows Defender - Demystifying and Bypassing ASR by Understanding the AV's Signatures - BlackHat Europe 2021](https://www.blackhat.com/eu-21/briefings/schedule/index.html#windows-defender---demystifying-and-bypassing-asr-by-understanding-the-avs-signatures-24866)
[^2]:[overview-attack-surface-reduction](https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/overview-attack-surface-reduction?view=o365-worldwide)
[^3]:[Use attack surface reduction rules to prevent malware infection]([Use attack surface reduction rules to prevent malware infection | Microsoft Docs](https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/attack-surface-reduction?view=o365-worldwide))
[^4]: [减少攻击面常见问题解答 （FAQ） |微软文档 (microsoft.com)](https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/attack-surface-reduction-faq?view=o365-worldwide)
[^5]: [Attack surface reduction rules | Microsoft Docs](https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/attack-surface-reduction-rules?view=o365-worldwide&block-adobe-reader-from-creating-child-processes)
[^6]:[https://github.com/taviso/loadlibrary#windows-defender](https://github.com/taviso/loadlibrary)
[^7]: [WDExtract](https://github.com/hfiref0x/WDExtract)

