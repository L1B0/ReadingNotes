# Protected Process Light is not Protected: MemoryRanger Fills The Gap Again（2021）

## 出发点

- 为了防止非法访问关键进程的内存以及数字版权管理(DRM)的要求，Windows OS采用PPL(Protected Process Light);
- 问题：入侵者可以使用内核驱动来禁用PPL，从而访问受保护的进程内存；并且可以为malware开启PPL；
- 原因：PatchGuard不检查PPL的完整性；
- 解决：本文提出基于hypervisor的解决方案MemoryRanger。
  - 在enclave中运行新加载的驱动程序；
- 本文方法不适用以下情况：
  - Lagrasta[27]展示了如何通过在NtlmShared.dll中hook MsvpPasswordValidate来提取密码散列;
  - Ciholas[28]揭示了如何获得受保护进程的处理，包括反恶意软件和反作弊保护解决方案;
  - Forshaw[29]使用COM技术的一个特性将任意代码注入到PPL中;
  - 另一种方法是通过使用合法的comsvcs.dll库[30]转储LSASS进程的内容来获取凭证;

## 介绍

### PP Model

进程内存的保护对于各个领域都至关重要，包括数字版权管理(DRM)市场、游戏和反病毒行业以及证书保护。

为了满足这些需求，Windows扩展了它的安全模型[1]，并引入了受保护的过程模型(PP)来为高价值内容提供更多的保护。

该模型提供了几个新的安全特性，包括**限制**使用管理权限运行的其他进程对**受保护进程内存的读写访问**。

为了作为PP加载磁盘上的映像文件必须使**用Microsoft证书签名**。

### PPL

PPL特性是通过在EPROCESS结构中添加一个新的PS_PROTECTION字节实现的。这个字节是为PPL进程设置的，并在Windows  API例程中检入。

恶意软件驱动程序可以禁用PPL保护通过清除这个字节，这将停止对该进程的限制访问。这种DKOM攻击对平台安全至关重要。

微软专家考虑通过禁止恶意代码的数字签名来防止此类攻击，并使用内核补丁保护(KPP/PatchGuard)和受保护环境认证和授权导出驱动程序(PEAuth)来识别此类攻击.

## PPL细节

> 介绍PPL的实现原理，以及存在的缺陷。

PPL包含三个元素：受保护的签名者、受保护的类型以及审计模式。并且加载到受保护进程中的**所有dll**也必须使用**相同的证书**进行签名。

PPL被应用于保护关键OS APP的内存，以及各种安全厂商的软件，如Bitdefender [33], Cisco [34], ESET [35], **Kaspesky** [36], SolarWinds [37], McAfee [38].

PPL限制了不受保护的进程对受保护的活动，包括**线程注入、内存写入、调试以及内存转储**。

### 激活和检查PPL

PPL是自动激活的，但在某些情况下，例如，为了激活LSASS进程的本地安全机构(LSA)保护，必须采取以下步骤[40]。

检查PPL可以调用如下API，原理都是读取进程的EPROCESS结构体: 

- ZwQueryInformationProcess with 
  ProcessProtectionInformation flag
- PsGetProcessProtection
- PsIsProtectedProcess
- PsIsProtectedProcessLight

### 实现细节

#### 1) EPROCESS 更新

#### 2) 创建PPL进程

有几个条件，

第一个是二进制文件必须有由Microsoft提供的签名，但目前只对Microsoft二进制文件可用。

在启动过程PspInitPhase和运行时通过调用NtCreateProcess可以创建受保护的进程，如图2所示。

![image-20211208202538346](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211208202538346.png)

所有这些函数都使用相同的进程管理器例程SepSetTrustLevelForProcessToken来更新字段Protection  PS_PROTECTION[46]。

Windows提供了一个带有SERVICE_CONFIG_LAUNCH_PROTECTED标志的ChangeServiceConfig2例程来使用ELAM以PPL方式运行服务，服务保护类型存储在SERVICE_LAUNCH_PROTECTED_INFO结构中[31,478,48]。

#### 3）访问进程内存

访问普通进程的内存必须调用如下API：

- OpenProcess
- ReadProcessMemory\WriteProcessMemory
- CloseHandle

#### 4）使用OpenProcess接口禁用PPL

MSDN描述了OpenProcess函数使用安全描述符对caller的访问权限进行检查。

如果调用者已经启用了**SeDebugPrivilege**特权，那么不管安全描述符的内容如何，请求的访问都会被授予。

在最新的win10中，该部分在nt!PsOpenProcess中实现。

![image-20211208203010091](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211208203010091.png)

开启SeDebugPrivilege后，可以获得进程的句柄，但是对于PPL进程，还有额外的一个检查。

#### 5）使用OpenProcess接口开启PPL

nt!RtlTestProtectedAccess和nt!PspCheckForInvalidAccessByProtection会对PPL进程的PS_PROTECTION字段进行检查。

![image-20211208203612218](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211208203612218.png)

### PPL未受保护

PPL安全特性仅基于在**OpenProcess**调用过程中**检查EPROCESS的保护字段**。同时，可以修改该字段，以禁用操作系统内置的关键进程的PPL，反之亦然，以将一个未受保护的进程提升为受保护的进程。

**攻击者**可以通过**禁用PPL保护功能轻易地杀死AV解决方案**（嘿嘿嘿），并从LSASS内存中窃取用户的证书。此外，他们可以使用PPL保护他们的恶意应用程序（这倒没有想到！）。

## 证明PPL的缺陷-Mimikatz可以关闭PPL

- 说明PPL机制的缺陷：用Mimikatz通过关闭LSASS的PPL，进而提取用户密码；
- 现有防御Mimikatz的机制；

### A. 攻击LSASS

调用Mimikatz命令如下：

1) privilege::debug - SeDebugPrivilege for Mimikatz；
2) lsadump::lsa /inject - 提取密码的hash；

更新后的Mimikatz可以通过patch进程的EPROCESS结构体来关闭PPL：

1) !+ - loads a Mimikatz driver
2) !processprotect /process:lsass.exe /remove  - 关闭PPL
3) privilege::debug - SeDebugPrivilege for Mimikatz；
4) lsadump::lsa /inject - 提取密码的hash；

![image-20211209102625675](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211209102625675.png)

另一种攻击的思路是提升malware的权限，只要比LSASS的PPL高，就可以访问其进程内存。

修改进程的PPL，结果如下图：

![image-20211209102858543](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211209102858543.png)

### B. 现有防御措施

## 本文工作-MemoryRanger

> MR提供可信的受保护进程。

### 简要介绍

MR有两个部分组成：一个内核驱动和一个Type 1 hypervisor：

- Driver：注册多个回调函数接收OS活动，如驱动（加载、卸载）、进程（创建、终止）；
- Hypervisor: MR可以通过重置内存页上相应的访问位来捕获对内存页的读、写、执行访问。

### PPL Safeguarding: MemoryRanger Updates

为了实现MR阻止对EPROCESS结构的保护字段的所有写访问，而不限制读访问，进行了更新。

- Driver:

  - 定位所有进程的EPROCESS，并维护一个Active Protected Processes列表；
  - 监控进程的创建和终止，从而实时更新APL；
  - 定位APL的每个进程的PS_PROTECTION地址，并发送给Hypervisor;

- Hypervisor：

  - 允许或禁止相应enclave的内存区域的访问；
  - 触发内存访问例外，决定是否是对PS结构体的写访问；

  

  ![image-20211208210758645](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211208210758645.png)

  ![image-20211208210814629](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211208210814629.png)

### 测试

开销约50%，可能的原因如下：

- MR被设计为一种概念验证解决方案，用于演示防止内核攻击的能力，其性能并不是优先考虑的问题。可以改进MR的内部调度算法，提高其整体性能。
- 分配给虚拟机操作系统的资源有限，性能下降加剧。使用更强大的测试平台可以提高性能结果。VMware工作站仿真VMX特性，这额外地消耗CPU资源。



#### 与MDCG对比

![image-20211209105050979](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211209105050979.png)

