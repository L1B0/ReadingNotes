# Portable Executable File Corruption Preventing Malware From Running（2017）

## 出发点

作者运行PE时经常遇到下列报错：

- “This is not a valid Win32 file” 
- “This file is not compatible with the operating system version. You may be trying to run a 64 bit file on a 32 bit system” 

由此产生一个问题：

- 在 PE 文件中，什么类型的障碍和异常会使 Windows/Portable Executable/Image Loader 和其他 PE 解析程序无法加载文件或显示错误消息？

答案有什么价值:

- 如果文件不加载，就不能动态分析它，因此分析人员处理的分析功能有一半被移除，只剩下静态分析
- 它将允许分析人员确定文件是否不会在指定的系统或指定的环境中加载，或者根本不会加载。如果一个文件不会在任何系统上加载，那么它就不是恶意软件，因为它不能运行和执行恶意活动。

## PE文件的目的



```cpp
typedef struct _IMAGE_DOS_HEADER
{
     WORD e_magic;
     WORD e_cblp;
     WORD e_cp;
     WORD e_crlc;
     WORD e_cparhdr;
     WORD e_minalloc;
     WORD e_maxalloc;
     WORD e_ss;
     WORD e_sp;
     WORD e_csum;
     WORD e_ip;
     WORD e_cs;
     WORD e_lfarlc;
     WORD e_ovno;
     WORD e_res[4];
     WORD e_oemid;
     WORD e_oeminfo;
     WORD e_res2[10];
     LONG e_lfanew; // offset 60 
} IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;
```

### What happens when a user double-clicks an .exe file?



> Out of all of the data structures you see in the .exe file, only a few are actually needed for the Loader to load the file.
>
> This means that malware authors can modify these PE data structures in such a way to make the file either only compatible with certain target machines or potentially crash or confuse analysis tools, yet still be perfectly runnable by the Loader. 

