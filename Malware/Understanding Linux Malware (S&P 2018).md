# Understanding Linux Malware (S&P 2018)

## 0. 概要

- 存在的问题：
  - 反病毒行业对恶意Linux程序的关注不够，而现在嵌入式设备越来越流行，存在许多的安全问题。
  - 由于嵌入式设备是在各种其他CPU架构上构建的，而且通常是在资源有限的硬件上，采用类unix操作系统，于是对恶意Linux程序的安全研究是十分重要的。
  - 一些样本已经实现了大范围的VM检测方法，而沙箱技术却没有相应的对抗措施。
- 工作：
  - 提出了第一个专门为Linux恶意软件设计的恶意软件分析管道的设计和实现细节。
  - 展示了对**10548**个恶意软件样本(在一年内收集)进行的首次大规模测量研究的结果，记录了详细的统计数据和见解，有助于指导该领域的未来工作。

## 1. 存在的挑战

### A. 多种多样的目标

与Windows、MacOS或Android系统的malware分析系统可以依赖底层执行环境的详细信息相比，基于Linux的malware可以针对各种各样的目标系统，例如互联网路由器、打印机、监控摄像头、智能电视或医疗设备。

更为重要的是，ELF文件没有指定它们的目标运行环境，这使得很难正确的配置执行环境。

- 计算机体系结构：Linux支持**几十种**不同的架构。这需要分析人员准备不同的分析沙箱，并移植不同的特定于体系结构的分析组件来支持每一个沙箱。
  - 在最近关于Mirai僵尸网络[4]的工作中，作者支持三种架构:**MIPS 32位、ARM 32位和x86 32位**。然而，这只涵盖了Linux中恶意软件的一小部分。例如，这三种架构加起来只覆盖我们**数据集的32%**。此外，一些系列(如ARM)的支持尤其困难，因为它们包含大量不同的CPU架构。
- 加载器和链接库：
  - 一个常见的例子是与uClibc或musl动态链接的Linux程序，它们比传统glibc更小、性能更好。分析环境不仅需要安装这些替代方案，而且还需要它们对应的加载器。
- 操作系统：
  - 将为Linux编译的ELF程序与其他ELF兼容的操作系统(如FreeBSD或Android)区分开来是很有挑战性的。
  - ELF头包含一个**“OS/ABI”字段**，原则上，该字段应该指定程序运行所需要的操作系统。
  - 例如，Linux和Android的ELF二进制文件指定了一个通用的“System V” OS/ABI。当前的Linux内核似乎忽略了这个字段，并且一个指定“FreeBSD”作为其OS/ABI的二进制程序可能是一个有效的Linux程序。
  - 事实上，Linux和FreeBSD的**系统调用号和参数**通常不匹配，因此静态链接的程序在遇到这样的差异时通常会崩溃。这些差异可能也存在于不同版本的Linux内核之间，并且自定义修改在嵌入式设备的世界中并不少见。

### B. 静态链接

- 静态链接可以提供许多优势,其中包括使生成的二进制更方便(因为它将执行正确,即使它的依赖性不是安装在目标环境),使其**难以逆向工程**(如难以识别二进制使用的哪些库函数)。

### C. 分析环境

- 除了正确的架构、库和OS
- 还有程序运行时应该具有的特权。通常，恶意软件分析沙箱以**普通的非特权用户**的身份执行样本。
- 管理权限会给恶意软件篡改沙盒本身的能力，并且会使检测和观察程序行为变得更加复杂。而且，期望超级用户权限工作的Windows示例非常少见。
- 不幸的是，编写Linux恶意软件时通常假设(对某些嵌入式目标类来说确实如此)其代码将以**root权限**运行。

### D. 缺少相关研究工作

。

## 2. 分析框架

结合了现有的先进技术AVClass [5], IDA Pro, radare2 [6] 和 Nucleus [7]。

![image-20211207143846935](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211207143846935.png)

### A. 数据集

- 工具：VirusTotal - Intelligence API
- 时间范围：2016年11月到2017年11月之间；
- 筛选方式：每天下载**200**个候选样本。我们的选择标准旨在最小化非linux二进制文件，并为每天观察的每个family选择至少一个样本。
  - 我们还将我们的选择分为两组:140个样本来自于超过5个AV阳性匹配，60个样本来自于AV评分在1到5之间；

### B. 文件 & 元数据分析

分析的第一阶段主要关注文件本身。ELF文件格式中包含的某些字段是操作系统在运行时所必需的，因此需要提供关于应用程序运行所基于的体系结构以及文件中包含的代码类型(例如，可执行文件或共享对象)的可靠信息。

作者为ELF格式实现了自定义解析器，因为现有的解析器(如章节V-A所述)常常无法处理畸形字段、意外值或丢失的信息。

- 过滤：共享库、内核转储、损坏的文件或其它OS的文件；
- 分类：AVClass，输出家族类名；
  - VirusTotal报告每个样本的av标签，并将它们输入AVClass工具，以获得该恶意软件家族的规范化名称。

### C. 静态分析

- 二进制代码分析
  - IDA Pro
  - 代码段指令分布，文件的熵值等

- 加壳检测
  - 聚合从ELF头中提取的信息和上一步的结果，以确定可能加壳的应用程序（如UPX，直接脱壳）

### D. 动态分析

- 基于KVM的虚拟化沙箱，支持x86和x64;
- 基于QEMU的模拟的沙箱，支持ARM 32，MIPS 32, PowerPC 32.

## 3. 数据集分析

- 数据集中有大量的僵尸网络样本（69%，超过25种家族）；

### A. 导致异常文件(但仍然遵循ELF规范)的修改（5%）

- 最常见的例子(我们数据集中样本的5%)包括删除关于ELF部分的所有信息。根据规范，这是有效的(因为section信息不会在运行时使用)；
- 伪造ABI信息。
  - Mumblehard家族的样本在头文件中报告了他们需要FreeBSD的事实，但然后在运行时测试系统调用表来检测实际的操作系统，并在FreeBSD和Linux下正确执行。

### B. 产生无效文件的修改-但是操作系统仍然可以正确地执行无效文件（2%）

- 包含畸形或损坏的section信息（2%）；
  - 无效的e_shoff (section头表的偏移量)，e_shnum (section头表的条目数)，或者e_shentsize(seciton entries大小)；
  - TABLE II总结了ELF操作技巧；

![image-20211207145839131](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211207145839131.png)

- 对分析工具产生的影响：
  - readelf (GNU  Binutils)的一部分；
  - pyelftools(一个方便的Python库来解析和分析ELF文件)；
  - GDB调试器(事实上的标准在Linux和许多类unix系统)；
  - IDA Pro 7(在撰写本文时,最新版本最流行的商业反汇编程序、编译工具和逆向工程工具)。
  - 结果表明，所有的工具都能够正确地处理异常文件，但不幸的是，在处理无效字段时常常会导致错误。

![image-20211207145850707](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211207145850707.png)