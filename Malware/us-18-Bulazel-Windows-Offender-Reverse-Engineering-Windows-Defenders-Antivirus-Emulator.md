# Windows Offender: Reverse Engineering Windows Defender's Antivirus Emulator（BlackHat 2018）

> [slides](https://i.blackhat.com/us-18/Thu-August-9/us-18-Bulazel-Windows-Offender-Reverse-Engineering-Windows-Defenders-Antivirus-Emulator.pdf)
>
> [videos](https://www.youtube.com/watch?v=wDNQ-8aWLO0)

## 概要

* 深度了解Windows Defender反病毒的二进制模拟器机制
* 第一个关于逆向任意反病毒软件的二进制模拟器的演讲。

## videos notes

主要的接口 mpengine.dll：提供恶意软件的扫描和检测。

逆向js引擎[^1] (用于从二进制文件逆向得到的潜在的恶意代码分析)

### 出发点

1. 为什么使用模拟的方式？
   * 传统av模型：扫描文件，寻找已知的恶意软件签名（hash、特征码和文件特征等）；
     * 存在的问题：签名很容易被加壳代码、新的二进制文件绕过；
   * 解决方法（已经使用了超过15年）：在虚拟化的模拟环境中运行未知二进制文件，观察运行时行为或已知的签名；
     * 沙箱、动态分析、虚拟化、启发式、爆炸式分析（detonation analysis？）

### 分析过程

静态工具：IDA，微软公开的PDB

动态分析：

* 受保护的进程：无法调试，即使是本地的admin；
* 解决方法：为av的二进制使用自定义的loader；
  * loadlibrary：https://github.com/taviso/loadlibrary
    * 在Linux中的PE loader；
    * 只实现了对mpengine.dll的运行；
  * mpclient：https://git.io/fbp0X 打不开;)
    * <img src="http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206144602128.png" alt="image-20211206144602128" style="zoom: 50%;" />

### 模拟过程

1 __rsignal函数提供了Defender的扫描功能的入口点：输入为一串数据，输出恶意软件的分类结果；

2 Defender使用模拟的方式分析可执行文件，没有其它更深入的分析；

3 模拟结果会被Defender缓存，也就是说一个已知的文件只会模拟执行一次。

![image-20211206145107716](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206145107716.png)

### 插桩

* 以恶意软件的视角：当执行malware时，mpengine.dll被调用的函数就是插桩目标；
* hook&reuse

## 参考资料

[^1] [RECON-BRX-2018-Reverse-Engineering-Windows-Defender-s-JavaScript-Engine](bit.ly/2qio857)

