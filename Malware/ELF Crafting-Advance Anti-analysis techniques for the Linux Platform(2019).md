# ELF Crafting-Advance Anti-analysis techniques for the Linux Platform(2019)

> videos: https://youtu.be/adYOSO0tn9M

## Linux面临的威胁场景

![image-20211206161540932](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206161540932.png)

Linux威胁检测的挑战：

* 低可见性
* 低检测率

## 高级ELF崩溃技术

### ELF解析

#### secitons

- 节包含链接目标对象文件以构建可运行的 ELF 可执行文件所需的所有信息。链接时需要段，但运行时不需要。

- 编译后的ELF 二进制文件将有一个Section Header 表（一个Elf*_Shdr 条目数组）。

- 节可以包含不同的内容，包括代码、字符串、重定位或符号。
- 节的信息可以被完全移除或修改；
  - Symbol scrambling
  - Section scrambling
    - 如何规避：忽略该段；
    - ![image-20211206162408652](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206162408652.png)
    - ![image-20211206162530115](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206162530115.png)

![image-20211206162128092](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206162128092.png)

#### 1 byte parser breaker

- EI_MAG0-3: ELF magic 

- EI_CLASS: File class. 

- EI_DATA: File’s data encoding. 

- EI_VERSION: File’s version. 

- EI_OSABI: OS/ABI identification.

- EI_ABIVERSION: ABI version 

- EI_PAD: Start of padding bytes. 

- EI_NIDENT: Size of - EI_ident.

修改前:

![image-20211206162844491](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206162844491.png)

修改后：

![image-20211206163121126](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206163121126.png)

结果

![image-20211206163155549](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206163155549.png)、

#### Hiding dynamic entries

原理：

- 动态编译的ELF文件通常包含一个类型为PT_DYNAMIC的段，这个段包含发生动态链接所需的所有信息。
- 当有缺陷的PT_DYNAMIC段的文件进行动态链接，就会崩溃。

Android 打包程序在规避技术方面比独立的 ELF 恶意软件成熟得多。

- 在Android 应用程序中发现的大多数ELF 往往是共享对象。

- 共享对象的成功分析在很大程度上依赖于动态链接工件的可见性 （init_array、exports 等）

以下技术实现了一种从 PT_DYNAMIC 段中隐藏来自 ELF 共享对象的动态条目的方法：

- 检测异常：

  ![image-20211206163945649](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206163945649.png)

- 规避异常

  ![image-20211206164042469](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206164042469.png)

- 后续异常：动态节的大小超出范围

  ![image-20211206164134995](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206164134995.png)

- 内存和磁盘映像的不一致
  - ![image-20211206164718212](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206164718212.png)

- 动态节混淆技术：
  - ![image-20211206164441683](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206164441683.png)
  
  - 规避：dynamic segment offset = data segment offset + (vaddr dynamic segment - vaddr data segment)
  
    ![image-20211206164840532](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206164840532.png)

### 重定向劫持（Relocation Hijacking）

- ELF 文件包含一个非常复杂的重定位系统。

- 重定位信息保存在位于 ELF 对象内特定重定位部分的条目中。

- 这些条目以结构的形式实现：有两种不同的 Relocation 入口结构：Elfxx_Rel 和 Elfxx_Rela；



![image-20211206165140515](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206165140515.png)

Two ideas:

- EPO based on relocation tampering for PIE binaries

- Hiding constructors in Dynamically and Statically linked binaries

#### 技术流程

目标：在main函数之前执行自己构造的函数。

![image-20211206171959353](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211206171959353.png)

### 实验

