# Evading Security Products for Credential Dumping Through Exploiting Vulnerable Driver in Windows Operating Systems（2021）

## 出发点

尽管驱动程序会在新版本中打补丁，但旧的驱动程序仍然是带有经过签名的数字签名的良性程序，并受到杀毒软件的信任。

攻击者可以使用驱动程序的不安全版本来执行恶意操作。本研究演示了如何使用一个旧版本从2012年的英特尔网卡诊断驱动程序的Windows操作系统凭证转储。我们成功地在内存中收集凭证，而不需要防病毒程序发出任何通知。

通过回避几乎所有现有的安全产品的老化驱动程序，我们的结果提高了对来自脆弱驱动程序的潜在威胁的意识，并呼吁机制来反击这种攻击技术。

## 相关工作

KDMapper: 将未经签名的驱动映射到内核空间。

## 本文方法

1. 通过sc.exe加载有漏洞的驱动；
   * 提出调用sc.exe命令的方法，因为它将整个攻击链分成几个步骤。在一个进程中使用多个关键的winapi将使该进程**更容易被杀毒软件检测**到。
2. 与驱动通信，向ntoskrnl.exe的**NtShutdownSystem**地址写入shellcode；
   * 选择这个API的原因，首先，这个功能很少被软件和系统使用。
   * 其次，这个函数可以通过Windows内核的用户模式接口NTDLL从用户区调用。
   * 通过特征码搜索。
3. 执行shellcode，读取LSASS进程的内存。
   * ![image-20211209171006245](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211209171006245.png)

![image-20211209170225814](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211209170225814.png)

## 测试

2019年的DEFCON黑客大会上，Jesse和Shkatov发布了一份超过40个来自微软认证供应商[16]的暴露驱动程序的列表。

IQVW64.sys

作者对MD、Kaspersky、McAfee等五种av进行了测试，

1. Microsoft Defender: built-in anti-malware component of Microsoft Windows 10
2. Kaspersky Total Security 2021
3. McAfee Total Protection 2021
4. Trend Micro Maximum Security 2021
5. Malwarebytes Premium

![image-20211209171215945](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211209171215945.png)