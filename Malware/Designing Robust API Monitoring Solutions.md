# Designing Robust API Monitoring Solutions - 2020

## 1. 出发点

API监控的应用场景：

1. 恶意软件分析和代码逆向中，为了追踪一个不可信的软件如何与周围环境（操作系统）交互；
2. 程序的运行时监控、故障排除等方面的可靠性研究；

系统调用与用户层调用：

* 系统调用：沙箱中分析恶意软件与OS的交互；
* 用户层调用：理解样本如何实现某些功能；

## 2. 遇到的困难

在实现准确、可靠和透明的API监控解决方案的过程中，我们发现了6个挑战:

[C1]  透明度。添加用于拦截API调用的探测或其他工具可能会引入对手可以寻找的工件，或者与最近针对API劫持[16]的OS漏洞缓解措施发生冲突。

(C2)召回。软件栈中检测发生的点也决定了跟踪程序可以捕获多少实际调用(如我们在§2.2中看到的IAT挂钩的限制)。

(C3)覆盖率。跟踪API调用的参数值比单独跟踪API符号提供更多信息。有了大量的库，就需要用编程方法提取原型和数据类型声明，以避免不完整的信息检索。

(C4)输出值。跟踪程序应该能够捕获API调用的返回值，以及API写入调用者提供的输出位置的任何数据。

(C5)相关的调用。程序中的一个API调用可能会导致软件堆栈中的许多组件内部和组件间API调用:这些内部调用会增加监视日志，但几乎没有信息，应该过滤掉;

* 仅当在属于被分析程序的代码中进行调用并最终返回到该程序时才相关。此定义排除了内部调用或跳转到其他导出，以及API代码（§2.1）中的重定向，并捕获程序直接从其代码调用的系统调用。

(C6)派生的控制流。跟踪程序应该包括派生的执行流，如子进程和远程(即在其他进程中创建的)线程。攻击者还可以使用它们来隐藏API调用，不让分析调用。

* 为了处理[C6]，在分析的程序中，我们指的是代码第一次运行的进程、它创建的子进程和远程线程，以及任何递归副产品

![image-20211130150224398](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211130150224398.png)

## 3. 使用的方法

### Hook Insertion

Hook的方式十分关键

#### API Entry Points

插桩在API的prologue

#### API Exit Points

记录返回值和输出的参数，需要在执行结束时中断，以下是两种方式：

a. 在DLL加载的时候，对API的所有exit points放置hooks；

b. 在API entry time，对API调用的下一条指令的地方放置一个hook；

![image-20211130151127744](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211130151127744.png)

#### Argument Extraction

32位：堆栈

64位：rcx, rdx, r8, r9。

> https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170#parameter-passing

## 4.系统设计

SNIPER架构

![image-20211130154140778](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211130154140778.png)

### 插桩

版本1：Pin

版本2：Drakvuf，不可见的断点技术

### 相关调用和执行单元

Pin：操作单个进程，提供API来拦截子进程或远程进程的创建；

VT: 编写了一个VMI组件，它从一个被分析的进程开始，递归地跟踪子进程和远程线程的创建。该组件为被监视的线程及其外围进程维护一个id池。

syscall：NtCreateThreadEx和NtTerminateThread

### Hook Insertion和Callbacks

![image-20211130192653359](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211130192653359.png)

#### API Entry



#### API Exit Events

#### Argument Extraction

### System Calls

### 比较

## 测试的结果

![image-20211130162718669](http://gavinl1b0223342.oss-cn-beijing.aliyuncs.com/img/image-20211130162718669.png)

## 存在的不足

